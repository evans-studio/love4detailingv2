-- Pre-Migration: Remove Template-Based Stored Procedures
-- Date: 2025-07-10
-- Purpose: Remove stored procedures that depend on tables being dropped in main cleanup migration
-- This must run BEFORE the main schema cleanup migration

-- =============================================================================
-- STORED PROCEDURE CLEANUP
-- =============================================================================
-- These procedures reference tables that will be dropped (schedule_templates, schedule_slots)

-- Drop template-related stored procedures
DROP FUNCTION IF EXISTS manage_time_slot(
  p_action text,
  p_slot_id uuid,
  p_template_id uuid,
  p_day_of_week integer,
  p_start_time text,
  p_end_time text,
  p_duration_minutes integer,
  p_max_bookings integer,
  p_is_standard_slot boolean,
  p_custom_label text,
  p_slot_type text,
  p_display_order integer,
  p_admin_user_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS get_enhanced_available_slots(
  p_start_date date,
  p_end_date date,
  p_include_blocked boolean,
  p_template_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS apply_template_to_date_range(
  p_template_id uuid,
  p_start_date date,
  p_end_date date,
  p_skip_existing boolean,
  p_admin_user_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS increment_template_usage(
  p_template_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS bulk_copy_from_template(
  p_template_id uuid,
  p_target_dates date[],
  p_admin_user_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS bulk_delete_slots(
  p_slot_ids uuid[],
  p_admin_user_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS bulk_update_slots(
  p_slot_updates jsonb,
  p_admin_user_id uuid
) CASCADE;

DROP FUNCTION IF EXISTS generate_available_slots_from_template(
  p_template_id uuid,
  p_start_date text,
  p_end_date text,
  p_override_capacity integer
) CASCADE;

-- Drop any template-related views
DROP VIEW IF EXISTS template_schedule_overview CASCADE;
DROP VIEW IF EXISTS slot_utilization_view CASCADE;

-- Drop any template-related triggers
DROP TRIGGER IF EXISTS update_template_usage_trigger ON schedule_templates CASCADE;
DROP TRIGGER IF EXISTS validate_slot_times_trigger ON schedule_slots CASCADE;

-- =============================================================================
-- VERIFICATION
-- =============================================================================
-- Verify all template-related procedures are removed
-- SELECT routine_name FROM information_schema.routines 
-- WHERE routine_schema = 'public' AND routine_name LIKE '%template%';

-- Verify all template-related triggers are removed  
-- SELECT trigger_name FROM information_schema.triggers 
-- WHERE trigger_schema = 'public' AND trigger_name LIKE '%template%';

-- =============================================================================
-- NOTES
-- =============================================================================
-- This migration prepares for the main schema cleanup by removing dependencies
-- Run this migration first, then verify no errors before running the main cleanup
-- The main cleanup migration will drop the actual tables